name: Java CI/CD Pipeline with SAST, SCA, DAST and Secret Detection

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  secret-check-bash-only:
    name: Bash Secret Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run smart bash checks (–±–µ–∑ —Å–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∏)
        run: |
          echo "üîç Running smart secret detection (excluding workflow files)..."
          
          echo "=== CHECK 1: REAL database passwords in config ==="
          REAL_SECRET_FOUND=0
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ —Ñ–∞–π–ª—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (–∏—Å–∫–ª—é—á–∞–µ–º .github –∏ workflow —Ñ–∞–π–ª—ã)
          for file in $(find . -name "application*.yaml" -o -name "application*.yml" -o -name "application*.properties" 2>/dev/null | grep -v ".github"); do
            echo "Checking $file"
          
            # –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª –ø–æ—Å—Ç—Ä–æ—á–Ω–æ –¥–ª—è —Ç–æ—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
            line_num=0
            while IFS= read -r line || [ -n "$line" ]; do
              line_num=$((line_num + 1))
          
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä–æ–∫–∏ —Å password
              if echo "$line" | grep -q -i "password"; then
                # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º: –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, –ø—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è, –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è, –ø—Ä–∏–º–µ—Ä—ã
                if echo "$line" | grep -q -E "(#|//|\$\{|\${|example|test|changeme|dummy|placeholder|TODO|FIXME)"; then
                  continue
                fi
          
                # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ –ø–∞—Ä–æ–ª–∏: password: –∏–ª–∏ password=''
                if echo "$line" | grep -q -E "password:\s*$|password:\s*['\"]{2}"; then
                  continue
                fi
          
                # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –±–µ–∑ –∑–Ω–∞—á–µ–Ω–∏—è
                if echo "$line" | grep -q "password:" && ! echo "$line" | grep -q "password:\s*\S"; then
                  continue
                fi
          
                # –ï—Å–ª–∏ –¥–æ—à–ª–∏ —Å—é–¥–∞ - –≤–æ–∑–º–æ–∂–Ω–æ —Ä–µ–∞–ª—å–Ω—ã–π –ø–∞—Ä–æ–ª—å
                echo "  ‚ö†Ô∏è  Line $line_num: $line"
                echo "      ‚Üí Check if this is a real password. If yes, use: password: \${DB_PASSWORD}"
                REAL_SECRET_FOUND=1
              fi
            done < "$file"
          done
          
          echo ""
          echo "=== CHECK 2: .env files with actual values ==="
          ENV_WITH_VALUES=0
          if [ -f ".env" ]; then
            echo "  Found .env file, checking if it contains actual values..."
          
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —Ä–µ–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (–Ω–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ –Ω–µ –ø—É—Å—Ç—ã–µ)
            if grep -v "^#" .env | grep -v "^$" | grep -q "="; then
              echo "  ‚ùå .env file contains actual values (not just template)"
              echo "      ‚Üí Should be in .gitignore. Create .env.example for template."
              ENV_WITH_VALUES=1
            else
              echo "  ‚ÑπÔ∏è  .env is empty or only comments (ok for template)"
            fi
          fi
          
          echo ""
          echo "=== CHECK 3: Obvious API keys/secrets (excluding workflow files) ==="
          OBVIOUS_SECRETS=0
          
          # –ò—â–µ–º –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ (40+ —Å–∏–º–≤–æ–ª–æ–≤) - –≤–æ–∑–º–æ–∂–Ω—ã–µ API –∫–ª—é—á–∏
          # –ò—Å–∫–ª—é—á–∞–µ–º workflow —Ñ–∞–π–ª—ã –∏ —Ç–µ—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã
          if find . -type f -name "*.java" ! -path "./.github/*" ! -path "*/test/*" ! -name "*Test.java" \
            -exec grep -n '"[A-Za-z0-9]\{40,\}"' {} \; 2>/dev/null | \
            head -3 > /tmp/long_strings.txt && [ -s /tmp/long_strings.txt ]; then
            echo "  ‚ö†Ô∏è  Found very long strings (might be API keys):"
            head -3 /tmp/long_strings.txt
            OBVIOUS_SECRETS=1
          fi
          
          # –ò—â–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã —Ç–∏–ø–∞ AWS –∫–ª—é—á–µ–π, JWT —Ç–æ–∫–µ–Ω–æ–≤
          # –ò—Å–∫–ª—é—á–∞–µ–º .github –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é (workflow —Ñ–∞–π–ª—ã) –∏ —Ç–µ—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã
          if find . -type f \( -name "*.java" -o -name "*.properties" -o -name "*.yaml" -o -name "*.yml" \) \
            ! -path "./.github/*" ! -path "*/test/*" ! -name "*Test.java" \
            -exec grep -n -i "AKIA[0-9A-Z]\{16\}\|eyJ[a-zA-Z0-9_-]\{10,\}\\.[a-zA-Z0-9_-]\{10,\}\\.[a-zA-Z0-9_-]\{10,\}" {} \; 2>/dev/null | \
            head -3 > /tmp/pattern_secrets.txt && [ -s /tmp/pattern_secrets.txt ]; then
            echo "  ‚ö†Ô∏è  Found pattern matches (AWS keys, JWT tokens):"
            head -3 /tmp/pattern_secrets.txt
            OBVIOUS_SECRETS=1
          fi
          
          echo ""
          echo "=== FINAL DECISION ==="
          
          # –†–µ—à–∞–µ–º, –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ª–∏ pipeline
          if [ $ENV_WITH_VALUES -eq 1 ] || [ $OBVIOUS_SECRETS -eq 1 ]; then
            echo "‚ùå CRITICAL: Real secrets found!"
            echo "   Pipeline BLOCKED."
            echo "::error::REAL SECRETS DETECTED! Fix before continuing."
            exit 1
          elif [ $REAL_SECRET_FOUND -eq 1 ]; then
            echo "‚ö†Ô∏è  WARNING: Potential issues found"
            echo "   Pipeline will CONTINUE, but please review:"
            echo "   1. Check if 'password:' lines need values"
            echo "   2. If real passwords exist, use environment variables"
            echo "::warning::Review potential secrets in code"
            # –ù–ï –≤—ã—Ö–æ–¥–∏–º —Å –æ—à–∏–±–∫–æ–π - —Ç–æ–ª—å–∫–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
          else
            echo "‚úÖ All checks passed"
            echo "::notice::No secrets detected"
          fi

  build-app:
    name: Build Application
    runs-on: ubuntu-latest
    needs: secret-check-bash-only

    container:
      image: maven:3.9.10-eclipse-temurin-17

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Make mvnw executable
        run: chmod +x ./mvnw

      - name: Build with Maven Wrapper
        run: ./mvnw -B clean package

      - name: Upload JAR artifacts
        uses: actions/upload-artifact@v4
        with:
          name: vuln-app
          path: ./target/*.jar

  sast:
    name: SAST Security Scan
    runs-on: ubuntu-latest
    needs: build-app
    steps:
      - uses: actions/checkout@v4

      - run: |
          python3 -m pip install semgrep
          semgrep scan --config=auto --sarif --output=semgrep-results.sarif .

      - uses: actions/upload-artifact@v4
        with:
          name: sast-sarif-report
          path: semgrep-results.sarif
          retention-days: 7

      - uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: semgrep-results.sarif

  sca:
    name: SCA Dependency Check
    runs-on: ubuntu-latest
    needs: build-app

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Run OWASP Dependency Check
        run: mvn org.owasp:dependency-check-maven:check -DskipTests

      - uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report
          path: target/dependency-check-report.html
          retention-days: 7

  zap-baseline:
    runs-on: ubuntu-latest
    needs: build-app

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: vuln-app
          path: ./target

      - name: Create ZAP rules file
        run: touch zap-rules.tsv

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Run application
        run: |
          java -jar target/*.jar &
          sleep 30

      - name: Make workspace writable for ZAP
        run: chmod -R 777 "$GITHUB_WORKSPACE"

      - name: ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.9.0
        continue-on-error: true
        with:
          target: "http://localhost:8080"
          rules_file_name: "zap-rules.tsv"
          cmd_options: "-r zap-baseline-report.html"
          allow_issue_writing: false

      - name: Upload ZAP Baseline report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-baseline-report
          path: zap-baseline-report.html

  zap-api:
    runs-on: ubuntu-latest
    needs: build-app

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: vuln-app
          path: ./target

      - name: Create ZAP rules file
        run: touch zap-rules.tsv

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Run application
        run: |
          java -jar target/*.jar &
          sleep 30

      - name: Make workspace writable for ZAP
        run: chmod -R 777 "$GITHUB_WORKSPACE"

      - name: ZAP API Scan
        uses: zaproxy/action-api-scan@v0.10.0
        continue-on-error: true
        with:
          target: "http://localhost:8080/v3/api-docs"
          rules_file_name: "zap-rules.tsv"
          cmd_options: "-f openapi -r zap-api-report.html"
          allow_issue_writing: false

      - name: Upload ZAP API report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-api-report
          path: zap-api-report.html

  pipeline-summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs: [secret-check-bash-only, build-app, sast, sca, zap-baseline, zap-api]  # ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û!
    if: always()

    steps:
      - name: Create summary
        run: |
          echo "# Security Pipeline Results" > summary.md
          echo "Date: $(date)" >> summary.md
          echo "" >> summary.md
          
          echo "## Job Status" >> summary.md
          echo "- Secret Detection: ${{ needs.secret-check-bash-only.result }}" >> summary.md
          echo "- Build: ${{ needs.build-app.result }}" >> summary.md
          echo "- SAST: ${{ needs.sast.result }}" >> summary.md
          echo "- SCA: ${{ needs.sca.result }}" >> summary.md
          echo "- DAST (ZAP Baseline): ${{ needs.zap-baseline.result }}" >> summary.md
          echo "- DAST (ZAP API): ${{ needs.zap-api.result }}" >> summary.md
          
          if [[ "${{ needs.secret-check-bash-only.result }}" == "failure" ]]; then
            echo "‚ùå Pipeline blocked: Secrets detected" >> $GITHUB_STEP_SUMMARY
            echo "::error::Secrets detected in code" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.secret-check-bash-only.result }}" == "success" ]]; then
            echo "‚úÖ No secrets detected - Pipeline passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è Secret check status: ${{ needs.secret-check-bash-only.result }}" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload summary
        uses: actions/upload-artifact@v4
        with:
          name: pipeline-summary
          path: summary.md